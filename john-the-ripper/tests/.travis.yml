language: c
dist: trusty
services: docker

matrix:
  include:
  #Test JtR using a stable OS/compiler
  - env: TEST="stable;gcc;" BUILD_OPTS="--enable-werror"

  #Test JtR using a gcc build with asan and OpenCL
  - compiler: gcc
    env: TEST="usual;ASAN;OPENCL;" F=1

  #Test JtR using a gcc build with asan and OpenCL
  - compiler: gcc    #clang + ASAN + OpenCL build fails
    env: TEST="usual;ASAN;OPENCL;" F=2

  #Test JtR using an ordinary OpenCL build
  - compiler: clang
    env: TEST="usual;OPENCL;"

  #Test JtR using a "hot" OS/compiler
  - env: TEST="fresh;ASAN;clang;"        BUILD_OPTS="--enable-memdbg --enable-werror"
  - env: TEST="fresh;ASAN;gcc;"          BUILD_OPTS="--enable-memdbg --enable-werror"
    group: deprecated-2017Q3
  - env: TEST="fresh;ASAN;EXTRAS;clang;" BUILD_OPTS="--enable-memdbg --enable-werror"
  - env: TEST="fresh;ASAN;EXTRAS;gcc;"   BUILD_OPTS="--enable-memdbg --enable-werror"
    group: deprecated-2017Q3
  - env: TEST="ztex;ASAN;clang;"         BUILD_OPTS="--enable-ztex --enable-memdbg --enable-werror"

  #Test using TS - CPU formats
  - compiler: clang
    env: TEST="TS;"

  #Test using TS - OpenCL
  - compiler: clang
    env: TEST="TS;OPENCL;"

  #Test --internal using TS
  - compiler: clang
    env: TEST="TS --internal;OPENCL;"

  #Test a non OpenMP build with clang (unusual test environment)
  - compiler: clang
    env: TEST="usual;ASAN;" BUILD_OPTS="--disable-native-tests --disable-openmp"

  #Test a non SIMD build. Non OpenMP + clang build fails
  - env: TEST="usual;ASAN;OPENCL;" BUILD_OPTS="--disable-native-tests CPPFLAGS='-mno-sse2 -mno-mmx -U__SSE__'"

  #Enable alignment checking ubsan
  - compiler: clang
    env: TEST="usual;OPENCL;" BUILD_OPTS="--enable-ubsanalign"

  #Test fuzzing
  - env: TEST="fresh;POCL;clang;" FUZZ="zzuf" BUILD_OPTS="--enable-fuzz"

  - env: TEST="fresh;POCL;afl-clang-fast;" FUZZ="afl" BUILD_OPTS="--enable-fuzz"

  #Test --restore using TS
  #- env: TEST="TS --restore;" # WE KNOW IT IS NOT WORKING

  #Test the Ubuntu Snap package
  #- env: TEST="snap;" SNAPD can't work inside docker

  allow_failures:
  - env: TEST="TS;"

  - env: TEST="TS;OPENCL;"

  - env: TEST="TS --internal;OPENCL;"

  - env: TEST="usual;ASAN;" BUILD_OPTS="--disable-native-tests --disable-openmp"

  - env: TEST="usual;ASAN;OPENCL;" BUILD_OPTS="--disable-native-tests CPPFLAGS='-mno-sse2 -mno-mmx -U__SSE__'"

  - env: TEST="usual;OPENCL;" BUILD_OPTS="--enable-ubsanalign"

  - env: TEST="fresh;POCL;clang;" FUZZ="zzuf" BUILD_OPTS="--enable-fuzz"

  - env: TEST="fresh;POCL;afl-clang-fast;" FUZZ="afl" BUILD_OPTS="--enable-fuzz"

  #- env: TEST="snap;"

  fast_finish: true

script:
  - .travis/travis-ci.sh

