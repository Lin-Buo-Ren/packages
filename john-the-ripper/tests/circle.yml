machine:
  services: 
    - docker

dependencies:
  pre:
    - docker pull fedora:latest

test:
  override:
    - ? |
        case $CIRCLE_NODE_INDEX in
          0)
            docker run -v $(pwd):/cwd -v $(pwd)/.circle/circle-ci.sh:/circle-ci.sh -e BASE=fedora fedora bash -e -c "/circle-ci.sh x86_64"
            ;;
          1)
            docker run -v $(pwd):/cwd -v $(pwd)/.circle/circle-ci.sh:/circle-ci.sh -e BASE=fedora fedora bash -e -c "/circle-ci.sh i686"
            ;;
        esac
      :
        parallel: true

  post:
    - ? |
        case $CIRCLE_NODE_INDEX in
          0)
            mkdir -p build
            hash=`git rev-parse --short HEAD`
            zip -r build/JtR-x64-${hash}.zip run/ doc/ README.md README README-jumbo
            cp -r build/ $CIRCLE_ARTIFACTS/
            ;;
          1)
            mkdir -p build
            HASH=`git rev-parse --short HEAD`
            zip -r build/JtR-x32-$HASH.zip run/ doc/ README.md README README-jumbo
            cp -r build/ $CIRCLE_ARTIFACTS/
            ;;
        esac
      :
        parallel: true
